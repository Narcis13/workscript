---
phase: 01-flexdb-schema-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/api/src/plugins/workscript/services/FlexSchemaValidator.ts
  - apps/api/src/plugins/workscript/services/FlexDBService.ts
  - apps/api/src/plugins/workscript/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Column definitions are validated against schema before table creation"
    - "Index slot assignment enforces limits (3 string, 2 numeric, 2 date)"
    - "Table names are validated as snake_case alphanumeric"
    - "Service can create FlexDB table with validated columns"
    - "Duplicate table names within same application are rejected"
  artifacts:
    - path: "apps/api/src/plugins/workscript/services/FlexSchemaValidator.ts"
      provides: "Ajv-based column validation and slot assignment"
      exports: ["FlexSchemaValidator", "validateColumnDefinition", "assignIndexSlots"]
      min_lines: 100
    - path: "apps/api/src/plugins/workscript/services/FlexDBService.ts"
      provides: "Core service for FlexDB table operations"
      exports: ["FlexDBService"]
      min_lines: 150
  key_links:
    - from: "apps/api/src/plugins/workscript/services/FlexDBService.ts"
      to: "apps/api/src/plugins/workscript/schema/flexdb.schema.ts"
      via: "import schema tables and types"
      pattern: "from.*flexdb\\.schema"
    - from: "apps/api/src/plugins/workscript/services/FlexDBService.ts"
      to: "apps/api/src/plugins/workscript/services/FlexSchemaValidator.ts"
      via: "validates columns before insert"
      pattern: "FlexSchemaValidator|validateColumn"
---

<objective>
Create the FlexDB service layer with column validation and table creation logic.

Purpose: Implement the business logic for creating FlexDB tables with proper validation. This enables users to create tables at runtime (FLEX-01) with all 9 data types (TYPE-01 to TYPE-10).
Output: FlexSchemaValidator for Ajv validation, FlexDBService for table operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-flexdb-schema-foundation/01-RESEARCH.md
@.planning/phases/01-flexdb-schema-foundation/01-01-SUMMARY.md

# Schema created in Plan 01
@apps/api/src/plugins/workscript/schema/flexdb.schema.ts

# Existing service patterns
@apps/api/src/plugins/workscript/services/WorkflowService.ts
@apps/api/src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FlexSchemaValidator</name>
  <files>apps/api/src/plugins/workscript/services/FlexSchemaValidator.ts</files>
  <action>
Create the Ajv-based validation service with:

**Ajv Setup:**
```typescript
import Ajv, { JSONSchemaType } from 'ajv';
import type { FlexColumnDefinition, FlexDataType } from '../schema/flexdb.schema';

const ajv = new Ajv({ allErrors: true, useDefaults: true });
```

**Column Definition JSON Schema:**
Define JSONSchemaType<FlexColumnDefinition> with:
- name: string, pattern ^[a-z][a-z0-9_]*$ (snake_case), maxLength 64
- dataType: enum of all 9 types
- displayName: optional string
- required: optional boolean
- unique: optional boolean
- indexed: optional boolean
- defaultValue: optional any
- validation: optional object with maxLength, minLength, pattern, enum, min, max, targetTable, onDelete, computed

**Compile validator once:**
```typescript
const columnSchema: JSONSchemaType<FlexColumnDefinition> = { ... };
const validateColumnInternal = ajv.compile(columnSchema);
```

**Export validateColumnDefinition function:**
```typescript
export function validateColumnDefinition(
  data: unknown
): { valid: true; data: FlexColumnDefinition } | { valid: false; errors: string[] }
```
- Returns typed result with validated data or error messages
- Extracts human-readable errors from Ajv errors array

**Export validateTableName function:**
```typescript
export function validateTableName(name: string): { valid: boolean; error?: string }
```
- Must match ^[a-z][a-z0-9_]*$
- Length 1-64 characters
- Returns error message if invalid

**Index Slot Assignment:**
```typescript
interface IndexSlotAssignment {
  str_1?: string;
  str_2?: string;
  str_3?: string;
  num_1?: string;
  num_2?: string;
  date_1?: string;
  date_2?: string;
}

const SLOT_LIMITS = {
  string: 3,  // str_1, str_2, str_3
  numeric: 2, // num_1, num_2
  date: 2     // date_1, date_2
};

export function assignIndexSlots(
  columns: FlexColumnDefinition[],
  existingAssignments: IndexSlotAssignment = {}
): { assignments: IndexSlotAssignment; errors: string[] }
```
- Assign indexed columns to slots based on dataType
- string/text -> string slots
- integer/decimal -> numeric slots
- date/datetime -> date slots
- boolean/json/reference -> string slots (cast to string)
- Return errors if slots exhausted

**Export getSlotType helper:**
```typescript
export function getSlotType(dataType: FlexDataType): 'string' | 'numeric' | 'date'
```

**Export FlexSchemaValidator class (optional, for DI):**
```typescript
export class FlexSchemaValidator {
  validateColumn = validateColumnDefinition;
  validateTableName = validateTableName;
  assignIndexSlots = assignIndexSlots;
}
```
  </action>
  <verify>
Create a test file and run: validates valid column, rejects invalid dataType, rejects bad table name, enforces slot limits
  </verify>
  <done>
FlexSchemaValidator.ts exists with validateColumnDefinition, validateTableName, assignIndexSlots functions, all exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FlexDBService</name>
  <files>apps/api/src/plugins/workscript/services/FlexDBService.ts</files>
  <action>
Create the core FlexDB service with:

**Imports:**
```typescript
import { db } from '../../../db';
import { eq, and } from 'drizzle-orm';
import { createId } from '@paralleldrive/cuid2';
import {
  flexTables,
  flexTableVersions,
  FlexColumnDefinition,
  FlexTableSchema,
  FlexTable,
  NewFlexTable,
  SchemaChange
} from '../schema/flexdb.schema';
import {
  validateColumnDefinition,
  validateTableName,
  assignIndexSlots
} from './FlexSchemaValidator';
```

**Service Result Types:**
```typescript
type ServiceResult<T> =
  | { success: true; data: T }
  | { success: false; error: string; code: 'VALIDATION_ERROR' | 'DUPLICATE' | 'NOT_FOUND' | 'INTERNAL' };
```

**createTable method:**
```typescript
async createTable(
  applicationId: string,
  name: string,
  columns: FlexColumnDefinition[],
  options?: { displayName?: string; createdBy?: string }
): Promise<ServiceResult<FlexTable>>
```

Implementation:
1. Validate table name with validateTableName
2. Validate each column with validateColumnDefinition
3. Check for duplicate table name in same application:
   ```typescript
   const existing = await db.query.flexTables.findFirst({
     where: and(
       eq(flexTables.applicationId, applicationId),
       eq(flexTables.name, name),
       eq(flexTables.isActive, true)
     )
   });
   ```
4. If exists, return { success: false, error: 'Table already exists', code: 'DUPLICATE' }
5. Assign index slots with assignIndexSlots
6. If slot errors, return validation error
7. Create schema object: { columns, version: 1 }
8. Insert into flex_tables:
   ```typescript
   const id = createId();
   await db.insert(flexTables).values({
     id,
     applicationId,
     name,
     displayName: options?.displayName,
     schema: { columns, version: 1 },
     indexedColumns: assignments,
     version: 1,
     isActive: true
   });
   ```
9. Create initial version entry (version 1, previousSchema null)
10. Return created table

**getTable method:**
```typescript
async getTable(tableId: string): Promise<ServiceResult<FlexTable>>
```
- Find by ID, return NOT_FOUND if missing

**getTableByName method:**
```typescript
async getTableByName(applicationId: string, name: string): Promise<ServiceResult<FlexTable>>
```
- Find by app + name, return NOT_FOUND if missing

**listTables method:**
```typescript
async listTables(applicationId: string): Promise<FlexTable[]>
```
- Return all active tables for application

**Add metadata columns (FLEX-05):**
In createTable, automatically add to column list if not present:
- id (string, required, unique) - will be auto-generated
- created_at (datetime, required)
- updated_at (datetime, required)
- deleted_at (datetime, optional)

Note: Don't add these to user-visible schema, track separately or add with system: true flag.

**Export singleton or class:**
```typescript
export class FlexDBService {
  // ... methods
}

// Optional singleton
export const flexDBService = new FlexDBService();
```
  </action>
  <verify>
`bun run typecheck` passes
  </verify>
  <done>
FlexDBService.ts exists with createTable, getTable, getTableByName, listTables methods, validates columns, enforces uniqueness
  </done>
</task>

<task type="auto">
  <name>Task 3: Export Services from Index</name>
  <files>apps/api/src/plugins/workscript/services/index.ts</files>
  <action>
Update or create services index file to export FlexDB services:

```typescript
// Existing exports
export * from './WorkflowService';

// FlexDB exports
export * from './FlexSchemaValidator';
export * from './FlexDBService';
```

This makes services available via:
```typescript
import { FlexDBService, validateColumnDefinition } from '../services';
```
  </action>
  <verify>
`bun run typecheck` passes
Import { FlexDBService } from './services' works in test file
  </verify>
  <done>
Services index exports FlexSchemaValidator and FlexDBService
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes with no errors
2. FlexSchemaValidator validates:
   - Valid column: { name: 'email', dataType: 'string' } -> valid: true
   - Invalid dataType: { name: 'x', dataType: 'foo' } -> valid: false
   - Bad table name: 'My Table' -> error about invalid format
3. FlexDBService:
   - Can be instantiated
   - createTable with valid input returns success
   - createTable with duplicate name returns DUPLICATE error
4. Index slot assignment enforces 3/2/2 limits
</verification>

<success_criteria>
- [ ] FlexSchemaValidator.ts exists with all validation functions
- [ ] Ajv JSONSchemaType validates all 9 data types
- [ ] Table name validation enforces snake_case
- [ ] Index slot assignment respects limits (3 str, 2 num, 2 date)
- [ ] FlexDBService.ts exists with CRUD operations
- [ ] createTable validates columns before insert
- [ ] createTable checks for duplicate names per application
- [ ] createTable creates version 1 entry
- [ ] Services exported from index.ts
- [ ] Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-flexdb-schema-foundation/01-02-SUMMARY.md`
</output>
