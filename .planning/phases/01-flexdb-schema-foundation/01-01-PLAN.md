---
phase: 01-flexdb-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/plugins/workscript/schema/flexdb.schema.ts
  - apps/api/src/db/index.ts
autonomous: true

must_haves:
  truths:
    - "flex_tables table exists in database with JSON schema column"
    - "flex_table_versions table exists for tracking schema changes"
    - "TypeScript types are exported for FlexDB column definitions"
    - "Database schema supports all 9 data types in column definitions"
  artifacts:
    - path: "apps/api/src/plugins/workscript/schema/flexdb.schema.ts"
      provides: "Drizzle schema for flex_tables and flex_table_versions"
      exports: ["flexTables", "flexTableVersions", "FlexColumnDefinition", "FlexTableSchema", "FlexDataType"]
      min_lines: 150
  key_links:
    - from: "apps/api/src/plugins/workscript/schema/flexdb.schema.ts"
      to: "apps/api/src/db/index.ts"
      via: "schema re-export"
      pattern: "flexdb\\.schema"
---

<objective>
Create the Drizzle ORM database schema for FlexDB tables and TypeScript types for column definitions.

Purpose: Establish the database foundation for runtime table creation. Without this schema, no FlexDB operations are possible.
Output: Drizzle schema file with flex_tables and flex_table_versions tables, plus TypeScript types for all 9 data types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-flexdb-schema-foundation/01-RESEARCH.md

# Existing schema patterns to follow
@apps/api/src/db/schema/auth.schema.ts
@apps/api/src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FlexDB Drizzle Schema</name>
  <files>apps/api/src/plugins/workscript/schema/flexdb.schema.ts</files>
  <action>
Create the Drizzle ORM schema file with:

**flex_tables table:**
- id: VARCHAR(128) PRIMARY KEY, using cuid2 .$defaultFn()
- applicationId: VARCHAR(128) NOT NULL - scopes tables to apps
- name: VARCHAR(255) NOT NULL - table name (snake_case)
- displayName: VARCHAR(255) - human-readable name
- schema: JSON NOT NULL with .$type<FlexTableSchema>() - column definitions
- indexedColumns: JSON with .$type<Record<string, string>>() - maps columns to index slots
- version: INT NOT NULL DEFAULT 1 - schema version counter
- isActive: BOOLEAN NOT NULL DEFAULT true
- createdAt: TIMESTAMP NOT NULL defaultNow()
- updatedAt: TIMESTAMP NOT NULL defaultNow().onUpdateNow()
- deletedAt: TIMESTAMP NULL - soft delete

**Indexes for flex_tables:**
- UNIQUE on (applicationId, name) - enforce table name uniqueness per app
- INDEX on applicationId - fast app-scoped queries

**flex_table_versions table:**
- id: VARCHAR(128) PRIMARY KEY, cuid2
- tableId: VARCHAR(128) NOT NULL - FK to flex_tables
- version: INT NOT NULL - version number
- previousSchema: JSON NULL with .$type<FlexTableSchema | null>() - before state
- newSchema: JSON NOT NULL with .$type<FlexTableSchema>() - after state
- changes: JSON NOT NULL with .$type<SchemaChange[]>() - array of changes
- createdBy: VARCHAR(128) NULL - user who made change
- createdAt: TIMESTAMP NOT NULL defaultNow()

**Indexes for flex_table_versions:**
- INDEX on (tableId, version) - query version history

**TypeScript interfaces (export all):**
```typescript
export type FlexDataType =
  | 'string' | 'text' | 'integer' | 'decimal'
  | 'boolean' | 'date' | 'datetime' | 'json' | 'reference';

export interface FlexColumnValidation {
  maxLength?: number;
  minLength?: number;
  pattern?: string;
  enum?: string[];
  min?: number;
  max?: number;
  targetTable?: string;
  onDelete?: 'cascade' | 'set-null' | 'restrict';
  computed?: string;
}

export interface FlexColumnDefinition {
  name: string;
  dataType: FlexDataType;
  displayName?: string;
  required?: boolean;
  unique?: boolean;
  indexed?: boolean;
  defaultValue?: any;
  validation?: FlexColumnValidation;
}

export interface FlexTableSchema {
  columns: FlexColumnDefinition[];
  version: number;
}

export interface SchemaChange {
  type: 'add_column' | 'remove_column' | 'modify_column';
  column: string;
  details: {
    before?: FlexColumnDefinition;
    after?: FlexColumnDefinition;
  };
}
```

**Export Drizzle inferred types:**
```typescript
export type FlexTable = typeof flexTables.$inferSelect;
export type NewFlexTable = typeof flexTables.$inferInsert;
export type FlexTableVersion = typeof flexTableVersions.$inferSelect;
export type NewFlexTableVersion = typeof flexTableVersions.$inferInsert;
```

Follow the patterns from auth.schema.ts:
- Use createId from @paralleldrive/cuid2
- Add JSDoc comments explaining each field
- Use proper Drizzle imports from drizzle-orm/mysql-core
  </action>
  <verify>
Run `bun run typecheck` from monorepo root - should pass with no errors in flexdb.schema.ts
  </verify>
  <done>
flexdb.schema.ts exists with flex_tables and flex_table_versions tables, all TypeScript types exported, type check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Register FlexDB Schema in Database Index</name>
  <files>apps/api/src/db/index.ts</files>
  <action>
Update the database index file to include the FlexDB schema:

1. Add import for flexdb schema:
```typescript
import * as flexdbSchema from '../plugins/workscript/schema/flexdb.schema';
```

2. Add to combined schema object:
```typescript
const schema = {
  ...automationsSchema,
  ...authSchema,
  ...integrationsSchema,
  ...aiSchema,
  ...resourcesSchema,
  ...flexdbSchema,  // Add this line
};
```

3. Add re-export at bottom:
```typescript
export * from '../plugins/workscript/schema/flexdb.schema';
```

This makes FlexDB tables and types available throughout the API.
  </action>
  <verify>
Run `bun run typecheck` - should pass
Run `cd apps/api && bun run db:push` - should create tables in database
  </verify>
  <done>
FlexDB schema is registered, db:push creates flex_tables and flex_table_versions tables
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes with no errors
2. `cd apps/api && bun run db:push` creates the tables
3. In Drizzle Studio (`bun run db:studio`): flex_tables and flex_table_versions tables visible with correct columns
4. Importing `{ FlexColumnDefinition, flexTables }` from `@db` works
</verification>

<success_criteria>
- [ ] flexdb.schema.ts exists with complete schema
- [ ] All 9 FlexDataType values defined
- [ ] FlexColumnDefinition interface has all required properties
- [ ] flex_tables has UNIQUE constraint on (applicationId, name)
- [ ] flex_table_versions has INDEX on (tableId, version)
- [ ] Schema registered in db/index.ts
- [ ] db:push creates tables successfully
- [ ] Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-flexdb-schema-foundation/01-01-SUMMARY.md`
</output>
