{
  "id": "workflow-generator",
  "name": "Meta-Workflow Generator",
  "version": "1.0.0",
  "description": "AI-powered workflow generator that creates production-ready Workscript workflows from natural language requirements. Uses the Reflection API for up-to-date node documentation, multi-step validation, and retry logic for robustness.",
  "initialState": {
    "userRequest": "",
    "model": "anthropic/claude-sonnet-4-20250514",
    "apiBaseUrl": "http://localhost:3013",
    "retryCount": 0,
    "maxRetries": 3,
    "generationComplete": false,
    "nodeDocumentation": "",
    "currentPrompt": "",
    "aiResponse": "",
    "cleanedResponse": "",
    "parsedJson": null,
    "generatedWorkflow": null,
    "lastError": null,
    "savedWorkflow": null,
    "saveSuccess": false,
    "saveError": null,
    "result": null
  },
  "workflow": [
    {
      "fetchApi": {
        "url": "{{$.apiBaseUrl}}/workscript/reflection/manifest/compact",
        "method": "GET",
        "headers": {
          "Authorization": "Bearer {{$.JWT_token}}",
          "Content-Type": "application/json"
        },
        "timeout": 10000,
        "success?": {
          "editFields": {
            "mode": "manual_mapping",
            "fieldsToSet": [
              {
                "name": "nodeDocumentation",
                "value": "$.fetchResponse.systemPrompt",
                "type": "string"
              }
            ],
            "success?": {
              "log": {
                "message": "Successfully fetched node documentation from Reflection API"
              }
            }
          }
        },
        "error?": {
          "editFields": {
            "mode": "manual_mapping",
            "fieldsToSet": [
              {
                "name": "nodeDocumentation",
                "value": "Use your general knowledge of Workscript workflow syntax. Available node types include: math, logic, transform, log, empty, filter, sort, aggregate, switch, splitOut, limit, editFields, summarize, transformObject, jsonExtract, removeDuplicates, validateData, compareDatasets, dateTime, stringOperations, mathOperations, arrayUtilities, objectUtilities, extractText, calculateField, ask-ai, runWorkflow, filesystem, database, auth, fetchApi. Follow the standard workflow JSON structure with id, name, version, and workflow array.",
                "type": "string"
              }
            ],
            "success?": {
              "log": {
                "message": "Using fallback node documentation - Reflection API unavailable"
              }
            }
          }
        },
        "clientError?": {
          "editFields": {
            "mode": "manual_mapping",
            "fieldsToSet": [
              {
                "name": "nodeDocumentation",
                "value": "Use your general knowledge of Workscript workflow syntax. Available node types include: math, logic, transform, log, empty, filter, sort, aggregate, switch, splitOut, limit, editFields, summarize, transformObject, jsonExtract, removeDuplicates, validateData, compareDatasets, dateTime, stringOperations, mathOperations, arrayUtilities, objectUtilities, extractText, calculateField, ask-ai, runWorkflow, filesystem, database, auth, fetchApi. Follow the standard workflow JSON structure with id, name, version, and workflow array.",
                "type": "string"
              }
            ],
            "success?": {
              "log": {
                "message": "Using fallback node documentation - API returned client error (possibly invalid JWT)"
              }
            }
          }
        },
        "serverError?": {
          "editFields": {
            "mode": "manual_mapping",
            "fieldsToSet": [
              {
                "name": "nodeDocumentation",
                "value": "Use your general knowledge of Workscript workflow syntax. Available node types include: math, logic, transform, log, empty, filter, sort, aggregate, switch, splitOut, limit, editFields, summarize, transformObject, jsonExtract, removeDuplicates, validateData, compareDatasets, dateTime, stringOperations, mathOperations, arrayUtilities, objectUtilities, extractText, calculateField, ask-ai, runWorkflow, filesystem, database, auth, fetchApi. Follow the standard workflow JSON structure with id, name, version, and workflow array.",
                "type": "string"
              }
            ],
            "success?": {
              "log": {
                "message": "Using fallback node documentation - server error from Reflection API"
              }
            }
          }
        }
      }
    },
    {
      "logic...": {
        "operation": "and",
        "values": [
          {
            "operation": "equal",
            "values": ["$.generationComplete", false]
          },
          {
            "operation": "less",
            "values": ["$.retryCount", "$.maxRetries"]
          }
        ],
        "true?": {
          "switch": {
            "mode": "expression",
            "item": "$.retryCount",
            "expression": "item > 0 ? 'retry' : 'first_attempt'",
            "first_attempt?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "currentPrompt",
                    "value": "$.userRequest",
                    "type": "string"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "First attempt - using original user request as prompt",
                    "success?": {
                      "ask-ai": {
                        "userPrompt": "Generate a complete, valid Workscript workflow JSON based on this request:\n\n{{$.currentPrompt}}\n\nCRITICAL INSTRUCTIONS:\n1. Return ONLY the raw JSON object - no markdown code blocks, no explanation text\n2. The workflow MUST have these required fields: id (kebab-case), name, version (semver like 1.0.0), workflow (non-empty array)\n3. Use proper state syntax: $.key for reading, {{$.key}} for template interpolation\n4. Each node should have appropriate edge handlers (success?, error?, etc.)\n5. Follow flat workflow structure - avoid deep nesting\n6. Only use node types documented in the system prompt",
                        "model": "$.model",
                        "systemPrompt": "You are an expert Workscript workflow generator. Your task is to create production-ready workflow JSON files.\n\n{{$.nodeDocumentation}}\n\nIMPORTANT RULES:\n1. Output ONLY valid JSON - no markdown, no explanation\n2. Every workflow needs: id, name, version, workflow array\n3. Use $.key syntax for state references\n4. Use {{$.key}} for string interpolation\n5. All edge names end with ? (success?, error?, etc.)\n6. Prefer flat workflow structure over deep nesting\n7. Include appropriate error handling edges",
                        "baseUrl": "$.apiBaseUrl",
                        "success?": {
                          "stringOperations": {
                            "operation": "replaceRegex",
                            "field": "aiResponse",
                            "outputField": "cleanedResponse",
                            "searchValue": "^```(?:json)?\\s*|\\s*```$",
                            "replaceValue": "",
                            "success?": {
                              "validateData": {
                                "validationType": "json",
                                "data": "$.cleanedResponse",
                                "valid?": {
                                  "editFields": {
                                    "mode": "manual_mapping",
                                    "fieldsToSet": [
                                      {
                                        "name": "generatedWorkflow",
                                        "value": "$.parsedJson",
                                        "type": "any"
                                      }
                                    ],
                                    "success?": {
                                      "validateData": {
                                        "validationType": "required_fields",
                                        "data": "$.generatedWorkflow",
                                        "requiredFields": ["id", "name", "version", "workflow"],
                                        "valid?": {
                                          "editFields": {
                                            "mode": "manual_mapping",
                                            "fieldsToSet": [
                                              {
                                                "name": "generationComplete",
                                                "value": true,
                                                "type": "boolean"
                                              }
                                            ],
                                            "success?": {
                                              "log": {
                                                "message": "Workflow generated successfully with all required fields"
                                              }
                                            }
                                          }
                                        },
                                        "invalid?": {
                                          "editFields": {
                                            "mode": "manual_mapping",
                                            "fieldsToSet": [
                                              {
                                                "name": "retryCount",
                                                "value": "$.retryCount + 1",
                                                "type": "number"
                                              },
                                              {
                                                "name": "lastError",
                                                "value": "Missing required fields: workflow must have id, name, version, and workflow array",
                                                "type": "string"
                                              }
                                            ],
                                            "success?": {
                                              "log": {
                                                "message": "Structure validation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                              }
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "invalid?": {
                                  "editFields": {
                                    "mode": "manual_mapping",
                                    "fieldsToSet": [
                                      {
                                        "name": "retryCount",
                                        "value": "$.retryCount + 1",
                                        "type": "number"
                                      },
                                      {
                                        "name": "lastError",
                                        "value": "Invalid JSON response from AI",
                                        "type": "string"
                                      }
                                    ],
                                    "success?": {
                                      "log": {
                                        "message": "JSON validation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            "error?": {
                              "editFields": {
                                "mode": "manual_mapping",
                                "fieldsToSet": [
                                  {
                                    "name": "retryCount",
                                    "value": "$.retryCount + 1",
                                    "type": "number"
                                  },
                                  {
                                    "name": "lastError",
                                    "value": "Failed to clean AI response",
                                    "type": "string"
                                  }
                                ],
                                "success?": {
                                  "log": {
                                    "message": "Response cleanup failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "error?": {
                          "editFields": {
                            "mode": "manual_mapping",
                            "fieldsToSet": [
                              {
                                "name": "retryCount",
                                "value": "$.retryCount + 1",
                                "type": "number"
                              },
                              {
                                "name": "lastError",
                                "value": "AI request failed",
                                "type": "string"
                              }
                            ],
                            "success?": {
                              "log": {
                                "message": "AI generation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "retry?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "currentPrompt",
                    "value": "RETRY ATTEMPT {{$.retryCount}} of {{$.maxRetries}}\n\nPREVIOUS ERROR: {{$.lastError}}\n\nCRITICAL: You MUST return ONLY valid JSON. Do NOT include markdown code blocks (```json or ```). Do NOT include any explanation text. Return ONLY the raw JSON object.\n\nRequired workflow structure:\n- id: string (kebab-case)\n- name: string\n- version: string (semver format like 1.0.0)\n- workflow: array (non-empty)\n\nORIGINAL REQUEST:\n{{$.userRequest}}",
                    "type": "string"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "Retry attempt {{$.retryCount}} - enhanced prompt with error context",
                    "success?": {
                      "ask-ai": {
                        "userPrompt": "Generate a complete, valid Workscript workflow JSON based on this request:\n\n{{$.currentPrompt}}\n\nCRITICAL INSTRUCTIONS:\n1. Return ONLY the raw JSON object - no markdown code blocks, no explanation text\n2. The workflow MUST have these required fields: id (kebab-case), name, version (semver like 1.0.0), workflow (non-empty array)\n3. Use proper state syntax: $.key for reading, {{$.key}} for template interpolation\n4. Each node should have appropriate edge handlers (success?, error?, etc.)\n5. Follow flat workflow structure - avoid deep nesting\n6. Only use node types documented in the system prompt",
                        "model": "$.model",
                        "systemPrompt": "You are an expert Workscript workflow generator. Your task is to create production-ready workflow JSON files.\n\n{{$.nodeDocumentation}}\n\nIMPORTANT RULES:\n1. Output ONLY valid JSON - no markdown, no explanation\n2. Every workflow needs: id, name, version, workflow array\n3. Use $.key syntax for state references\n4. Use {{$.key}} for string interpolation\n5. All edge names end with ? (success?, error?, etc.)\n6. Prefer flat workflow structure over deep nesting\n7. Include appropriate error handling edges",
                        "baseUrl": "$.apiBaseUrl",
                        "success?": {
                          "stringOperations": {
                            "operation": "replaceRegex",
                            "field": "aiResponse",
                            "outputField": "cleanedResponse",
                            "searchValue": "^```(?:json)?\\s*|\\s*```$",
                            "replaceValue": "",
                            "success?": {
                              "validateData": {
                                "validationType": "json",
                                "data": "$.cleanedResponse",
                                "valid?": {
                                  "editFields": {
                                    "mode": "manual_mapping",
                                    "fieldsToSet": [
                                      {
                                        "name": "generatedWorkflow",
                                        "value": "$.parsedJson",
                                        "type": "any"
                                      }
                                    ],
                                    "success?": {
                                      "validateData": {
                                        "validationType": "required_fields",
                                        "data": "$.generatedWorkflow",
                                        "requiredFields": ["id", "name", "version", "workflow"],
                                        "valid?": {
                                          "editFields": {
                                            "mode": "manual_mapping",
                                            "fieldsToSet": [
                                              {
                                                "name": "generationComplete",
                                                "value": true,
                                                "type": "boolean"
                                              }
                                            ],
                                            "success?": {
                                              "log": {
                                                "message": "Workflow generated successfully with all required fields"
                                              }
                                            }
                                          }
                                        },
                                        "invalid?": {
                                          "editFields": {
                                            "mode": "manual_mapping",
                                            "fieldsToSet": [
                                              {
                                                "name": "retryCount",
                                                "value": "$.retryCount + 1",
                                                "type": "number"
                                              },
                                              {
                                                "name": "lastError",
                                                "value": "Missing required fields: workflow must have id, name, version, and workflow array",
                                                "type": "string"
                                              }
                                            ],
                                            "success?": {
                                              "log": {
                                                "message": "Structure validation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                              }
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "invalid?": {
                                  "editFields": {
                                    "mode": "manual_mapping",
                                    "fieldsToSet": [
                                      {
                                        "name": "retryCount",
                                        "value": "$.retryCount + 1",
                                        "type": "number"
                                      },
                                      {
                                        "name": "lastError",
                                        "value": "Invalid JSON response from AI",
                                        "type": "string"
                                      }
                                    ],
                                    "success?": {
                                      "log": {
                                        "message": "JSON validation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            "error?": {
                              "editFields": {
                                "mode": "manual_mapping",
                                "fieldsToSet": [
                                  {
                                    "name": "retryCount",
                                    "value": "$.retryCount + 1",
                                    "type": "number"
                                  },
                                  {
                                    "name": "lastError",
                                    "value": "Failed to clean AI response",
                                    "type": "string"
                                  }
                                ],
                                "success?": {
                                  "log": {
                                    "message": "Response cleanup failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "error?": {
                          "editFields": {
                            "mode": "manual_mapping",
                            "fieldsToSet": [
                              {
                                "name": "retryCount",
                                "value": "$.retryCount + 1",
                                "type": "number"
                              },
                              {
                                "name": "lastError",
                                "value": "AI request failed",
                                "type": "string"
                              }
                            ],
                            "success?": {
                              "log": {
                                "message": "AI generation failed - retry {{$.retryCount}} of {{$.maxRetries}}"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "false?": null
      }
    },
    {
      "logic": {
        "operation": "equal",
        "values": ["$.generationComplete", false],
        "true?": {
          "log": {
            "message": "Workflow generation failed after {{$.retryCount}} of {{$.maxRetries}} retry attempts. Last error: {{$.lastError}}"
          }
        },
        "false?": null
      }
    },
    {
      "logic": {
        "operation": "equal",
        "values": ["$.generationComplete", true],
        "true?": {
          "fetchApi": {
            "url": "{{$.apiBaseUrl}}/workscript/workflows/create",
            "method": "POST",
            "headers": {
              "Authorization": "Bearer {{$.JWT_token}}",
              "Content-Type": "application/json"
            },
            "body": {
              "name": "$.generatedWorkflow.name",
              "description": "Auto-generated workflow from user request: {{$.userRequest}}",
              "definition": "$.generatedWorkflow",
              "version": "$.generatedWorkflow.version",
              "isActive": true
            },
            "timeout": 15000,
            "success?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "savedWorkflow",
                    "value": "$.fetchResponse.workflow",
                    "type": "any"
                  },
                  {
                    "name": "saveSuccess",
                    "value": true,
                    "type": "boolean"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "Workflow saved successfully with ID: {{$.savedWorkflow.id}}"
                  }
                }
              }
            },
            "clientError?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "saveError",
                    "value": "Client error: {{$.fetchResponse.error}}",
                    "type": "string"
                  },
                  {
                    "name": "saveSuccess",
                    "value": false,
                    "type": "boolean"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "Failed to save workflow - client error: {{$.saveError}}"
                  }
                }
              }
            },
            "serverError?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "saveError",
                    "value": "Server error occurred while saving workflow",
                    "type": "string"
                  },
                  {
                    "name": "saveSuccess",
                    "value": false,
                    "type": "boolean"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "Failed to save workflow - server error"
                  }
                }
              }
            },
            "error?": {
              "editFields": {
                "mode": "manual_mapping",
                "fieldsToSet": [
                  {
                    "name": "saveError",
                    "value": "Network error: {{$.error}}",
                    "type": "string"
                  },
                  {
                    "name": "saveSuccess",
                    "value": false,
                    "type": "boolean"
                  }
                ],
                "success?": {
                  "log": {
                    "message": "Failed to save workflow - network error: {{$.saveError}}"
                  }
                }
              }
            }
          }
        },
        "false?": null
      }
    },
    {
      "editFields": {
        "mode": "manual_mapping",
        "fieldsToSet": [
          {
            "name": "result",
            "value": {
              "success": "$.generationComplete && $.saveSuccess",
              "workflowId": "$.savedWorkflow.id",
              "workflow": "$.generatedWorkflow",
              "attempts": "$.retryCount + 1",
              "error": "$.saveError || $.lastError"
            },
            "type": "any"
          }
        ],
        "success?": {
          "logic": {
            "operation": "equal",
            "values": ["$.result.success", true],
            "true?": {
              "log": {
                "message": "Meta-workflow completed successfully. Generated workflow ID: {{$.result.workflowId}}"
              }
            },
            "false?": {
              "log": {
                "message": "Meta-workflow completed with errors. Error: {{$.result.error}}"
              }
            }
          }
        }
      }
    }
  ]
}
